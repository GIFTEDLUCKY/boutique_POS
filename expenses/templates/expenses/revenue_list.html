{% extends 'base.html' %}

{% block content %}
  <h1 class="h4">Revenue List</h1> <!-- Smaller heading -->

  <a href="{% url 'expenses:add_revenue' %}" class="btn btn-primary btn-sm">Return to Add Revenue</a>

  <h2 class="h2 text-end">Total Revenue: ₦ <span id="totalRevenue">{{ total_revenue }}</span></h2>


  <!-- Responsive Filters -->
  <div class="container p-2">
    <div class="row g-2">
      <div class="col-12 col-md-3">
        <label for="start_date" class="form-label small">Start Date:</label>
        <input type="date" id="start_date" class="form-control form-control-sm">
      </div>

      <div class="col-12 col-md-3">
        <label for="end_date" class="form-label small">End Date:</label>
        <input type="date" id="end_date" class="form-control form-control-sm">
      </div>

      <div class="col-12 col-md-3">
        <label for="filter_criteria" class="form-label small">Filter By:</label>
        <select id="filter_criteria" class="form-select form-select-sm">
          <option value="store">Store</option>
          <option value="description">Description</option>
          <option value="payment_method">Payment Method</option>
          <option value="added_by">Added By</option>
        </select>
      </div>

      <div class="col-12 col-md-3">
        <label for="search_input" class="form-label small">Search:</label>
        <input type="text" id="search_input" class="form-control form-control-sm" placeholder="Enter search term">
      </div>

      <div class="col-12 text-center mt-2">
        <button onclick="filterTable()" class="btn btn-success btn-sm">Search</button>
        <button onclick="resetFilters()" class="btn btn-danger btn-sm">Reset</button>
      </div>
    </div>
  </div>

  <!-- Responsive Table -->
  <div class="table-responsive">
    <table class="table table-bordered table-striped table-sm small" id="revenueTable">
      <thead class="thead-dark">
        <tr>
          <th>S/No.</th>
          <th>Store</th>
          <th>Amount Added</th>
          <th>Description</th>
          <th>Payment Method</th>
          <th>Date Added</th>
          <th>Added By</th>
          <th>Receipt</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for revenue in revenues %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td class="store">{{ revenue.store.name }}</td>
            <td class="amount">{{ revenue.amount }}</td>
            <td class="description">{{ revenue.description }}</td>
            <td class="payment_method">{{ revenue.payment_method }}</td>
            <td class="date_added">{{ revenue.date_added }}</td>
            <td class="added_by">{{ revenue.added_by.username }}</td>
            <td>
              <a href="{% url 'expenses:view_receipt' revenue.id %}" target="_blank" class="btn btn-primary btn-sm">View</a> 
              <a href="{% url 'expenses:download_receipt' revenue.id %}" download class="btn btn-success btn-sm">Download</a>
            </td>
            <td>
              <a href="{% url 'expenses:edit_revenue' revenue.id %}" class="btn btn-warning btn-sm">Edit</a>
              <a href="{% url 'expenses:delete_revenue' revenue.id %}" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure?');">Delete</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    function filterTable() {
        let startDate = document.getElementById("start_date").value;
        let endDate = document.getElementById("end_date").value;
        let filterCriteria = document.getElementById("filter_criteria").value;
        let searchTerm = document.getElementById("search_input").value.toLowerCase();
        
        let table = document.getElementById("revenueTable");
        let rows = table.getElementsByTagName("tr");
        let totalRevenue = 0;

        for (let i = 1; i < rows.length; i++) {
            let row = rows[i];
            let filterText = row.querySelector(`.${filterCriteria}`)?.innerText.toLowerCase();
            let dateAdded = row.querySelector(".date_added")?.innerText;
            let amount = parseFloat(row.querySelector(".amount")?.innerText) || 0;

            let matchesSearch = filterText.includes(searchTerm);
            let matchesDate = true;

            if (startDate && endDate) {
                let rowDate = new Date(dateAdded.split("-").reverse().join("-"));
                let start = new Date(startDate);
                let end = new Date(endDate);

                start.setHours(0, 0, 0, 0);
                end.setHours(23, 59, 59, 999);
                rowDate.setHours(0, 0, 0, 0);

                matchesDate = rowDate.getTime() >= start.getTime() && rowDate.getTime() <= end.getTime();
            }

            if (matchesSearch && matchesDate) {
                row.style.display = "";
                totalRevenue += amount;
            } else {
                row.style.display = "none";
            }
        }

        document.getElementById("totalRevenue").innerText = totalRevenue.toFixed(2);
    }

    function resetFilters() {
        document.getElementById("start_date").value = "";
        document.getElementById("end_date").value = "";
        document.getElementById("search_input").value = "";
        document.getElementById("totalRevenue").innerText = "₦ {{ total_revenue }}";

        let table = document.getElementById("revenueTable");
        let rows = table.getElementsByTagName("tr");
        for (let i = 1; i < rows.length; i++) {
            rows[i].style.display = "";
        }
    }
  </script>

{% endblock %}
