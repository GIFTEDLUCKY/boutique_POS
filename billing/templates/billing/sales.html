{% extends 'base.html' %}
{% load static %}

{% block title %}Billing & Sales{% endblock %}

{% block content %}

{% if warning_message %}
    <div class="alert alert-warning">
        {{ warning_message }}
    </div>
{% endif %}

<div id="customAlert" class="alert alert-warning d-none" role="alert"></div>

<div class="container mt-0">
    <h3 class="mb-4" style="font-size: 1.5rem;">Billing & Sales</h3>

    <form id="search_form">
        <input type="text" id="product_search" placeholder="Type or scan barcode..." autocomplete="off">
        <button id="reset_search" type="button" class="btn btn-danger">Reset</button>
    </form>
    
    <div class="row">

        <!-- Form Section -->
        <div class="col-md-4" style="font-size: 0.8rem; padding-right: 15px;">
            <form method="POST">
                {% csrf_token %}
                <!-- Customer Details -->
                <div class="mb-2">
                    
                    <input type="text" class="form-control" id="customer_name" name="customer_name" value="{{ customer_name|default:'' }}" placeholder="Enter customer name" required style="font-size: 0.85rem; padding: 5px 10px;">
                </div>

                

                <div class="mb-2">
                    <input type="text" class="form-control" id="phone_number" name="phone_number" value="{{ phone_number|default:'' }}" placeholder="Enter phone number" required style="font-size: 0.85rem; padding: 5px 10px;">
                </div>

                <!-- Product Selection -->
                <select multiple class="form-control" name="product_ids" id="product_ids" style="font-size: 0.85rem; padding: 5px 10px;" size="7">
                    {% for product in products %}
                        <option value="{{ product.id }}" 
                            data-barcode="{{ product.barcode }}" 
                            data-price="{{ product.selling_price }}" 
                            data-discounted-price="{{ product.discounted_price }}"   
                            data-taxed-price="{{ product.taxed_price }}"
                            data-discount="{{ product.discount }}" 
                            data-product-tax="{{ product.product_tax }}" 
                            data-stock="{{ product.quantity }}"
                            data-expiry="{{ product.expiry_date|date:'Y-m-d' }}">
                            {{ product.name }} - ₵ {{ product.selling_price }}
                        </option>
                    {% empty %}
                        <option disabled>No products available for this store</option>
                    {% endfor %}
                </select>

                <!-- Quantity Input -->
                <div class="mb-2">
                    <label for="quantity" class="form-label" style="font-size: 0.85rem;">Quantity</label>
                    <input type="number" class="form-control" id="quantity" name="quantities" min="1" value="1" required style="font-size: 0.85rem; padding: 5px 10px;">
                </div>

                <!-- Add to Cart Button -->
                <button type="button" class="btn btn-secondary mb-2" onclick="addToCart()" style="font-size: 0.85rem; padding: 5px 10px;">Add to Cart</button>

                <!-- Hidden Input for Cart Data -->
                <input type="hidden" id="cart_data" name="cart_data">

                <!-- Hidden Inputs for Discount and Tax -->
                <input type="hidden" id="discount" name="discounts" value="0">
                <input type="hidden" id="tax" name="taxes" value="0">

                <!-- Payment Method -->
                <div class="mb-2">
                    <label for="payment_method" class="form-label" style="font-size: 0.85rem;">Payment Method</label>
                    <select class="form-control" id="payment_method" name="payment_method" style="font-size: 0.85rem; padding: 5px 10px;">
                        <option value="cash">Cash</option>
                        <option value="card">Card</option>
                        <option value="Mobile Money">Mobile Money</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                    </select>
                </div>

                <!-- Payment and Change Calculation -->
                <div class="mb-2">
                    <label for="amount_paid" class="form-label" style="font-size: 0.85rem;">Amount Paid</label>
                    <input type="number" class="form-control" id="amount_paid" name="amount_paid" style="font-size: 0.85rem; padding: 5px 10px;">
                </div>
                <div class="mb-2">
                    <button type="button" class="btn btn-success" onclick="calculateChange()" style="font-size: 0.85rem; padding: 5px 10px;">Calculate Change</button>
                    <div id="change_display" class="mt-1" style="font-size: 0.75rem;"></div>
                </div>
                
            </form>
        </div>

        <!-- Cart Table Section -->
        <div class="col-md-8" style="font-size: 0.9rem;">
            <div class="cart-section">
                <h4 class="mb-3" style="font-size: 1.2rem;">Cart</h4>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Price (₵)</th>
                            <th>Subtotal (₵)</th>
                            <th>Actions</th>  <!-- ONLY ONE Action header -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Leave empty. JS will populate -->
                    </tbody>

                </table>


                <!-- Total and Checkout Section -->
                <div class="mt-4">
                    <!-- Display total from backend -->
                    <h1>Total: ₵ <span id="total_display">0.00</span></h1>

                    <button type="button" class="btn btn-primary" id="generate_invoice_btn">
                    Generate Invoice
                    </button>


                  
                    <button id="resetCartButton" class="btn btn-danger">Reset Cart</button>


                </div>

                <!-- Visible Change Result Below Cart -->
                <div class="mt-4 d-flex align-items-center justify-content-center" style="gap: 1rem; width: 100%;">
                    <label for="change" class="form-label mb-0" style="font-size: 3rem; font-weight: bold; color: green;">Change</label>
                    <span style="font-size: 3rem; font-weight: bold; color: green;">₵:</span>    
                    <input type="text" id="change" name="change" readonly style="
                        font-size: 3rem;
                        padding: 10px;
                        font-weight: bold;
                        text-align: left;
                        border: none;
                        background: transparent;
                        color: green;
                        width: auto;
                        min-width: 200px;
                    ">
                </div>
            </div>
        </div>

    </div>
</div>


            


<!-- Edit Quantity Modal -->
<div class="modal fade" id="editQuantityModal" tabindex="-1" aria-labelledby="editQuantityLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editQuantityForm">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="editQuantityLabel">Edit Quantity</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editItemId" name="item_id" />
          <div class="mb-3">
            <label for="quantityInput" class="form-label">Quantity</label>
            <input type="number" class="form-control" id="quantityInput" name="quantity" min="1" required />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save changes</button>
        </div>
      </form>
    </div>
  </div>
</div>



<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteConfirmLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this item from the cart?
        <input type="hidden" id="deleteItemId" />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="confirmDeleteBtn" class="btn btn-danger" data-bs-dismiss="modal">Delete</button>
      </div>
    </div>
  </div>
</div>







<!-- Reset Cart Modal -->
<div class="modal fade" id="resetCartModal" tabindex="-1" aria-labelledby="resetCartModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="resetCartModalLabel">Reset Cart</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="resetCartMessage">Are you sure you want to reset the cart?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmResetButton" class="btn btn-danger">Yes, Reset Cart</button>
            </div>
        </div>
    </div>
</div>



<!-- Generate Invoice Modal -->
<div class="modal fade" id="invoiceConfirmModal" tabindex="-1" aria-labelledby="invoiceConfirmModalLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="invoiceConfirmModalLabel">Generate Invoice</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to generate the invoice for the current cart?</p>
            </div>
            <div class="modal-footer">
                <!-- Cancel button to dismiss the modal -->
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="invoiceCancelBtn">Cancel</button>

                <!-- Confirm button to generate the invoice -->
                <button type="button" id="confirmInvoiceBtn" class="btn btn-primary">Yes, Generate Invoice</button>
            </div>
        </div>
    </div>
</div>



<!-- Empty Cart Modal -->
<div class="modal fade" id="emptyCartModal" tabindex="-1" aria-labelledby="emptyCartModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="emptyCartModalLabel">Your Cart is Empty</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Please your cart is empty, there is nothing to clear.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>



<!-- Empty Cart Modal -->
<div class="modal fade" id="emptyCartModal1" tabindex="-1" aria-labelledby="emptyCartModal1Label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="emptyCartModal1Label">Your Cart is Empty</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Please add items to your cart before Generating Invoice.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>


<!-- Modal for Low Stock Warning -->
<div class="modal fade" id="lowStockModal" tabindex="-1" aria-labelledby="lowStockModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="lowStockModalLabel">Low Stock Warning</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="lowStockMessage">
          <!-- Low stock message will be dynamically inserted here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  

  <!-- Expiry Warning Modal -->
<div class="modal fade" id="expiryModal" tabindex="-1" aria-labelledby="expiryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="expiryModalLabel">Product Expiry Alert</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="expiryMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>



<!-- Product Not Found Modal -->
<div class="modal fade" id="productNotFoundModal" tabindex="-1" aria-labelledby="productNotFoundModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="productNotFoundModalLabel"><i class="bi bi-exclamation-triangle-fill me-1"></i> Product Not Found </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body d-flex align-items-center">
          <!-- Spinner -->
          <div id="spinnerIcon" class="spinner-border text-warning me-2" role="status" style="display: none;">
            <span class="visually-hidden">Loading...</span>
          </div>
          <span id="productNotFoundMessage">Product not found.</span>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  

<!--======================================================================
-->



<input type="hidden" id="search-url" value="{% url 'billing:search_billing_product' %}">

  
<input type="hidden" id="invoice_id" value="{{ transaction_cart.id }}">




<!-- Load local jQuery -->
<script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script src="{% static 'js/sales_cart.js' %}"></script>





</body>




{% endblock %}
