{% extends 'base.html' %}
{% load static %}

{% block title %}Billing & Sales{% endblock %}

{% block content %}

{% if warning_message %}
    <div class="alert alert-warning">
        {{ warning_message }}
    </div>
{% endif %}

<div class="container mt-4">
    <h3 class="mb-4" style="font-size: 1.5rem;">Billing & Sales</h3>
    <div class="row">

        <!-- Form Section -->
        <div class="col-md-4" style="font-size: 0.8rem; padding-right: 15px;">
            <form method="POST">
                {% csrf_token %}

                <!-- Customer Details -->
                <div class="mb-2">
                    <label for="customer_name" class="form-label" style="font-size: 0.85rem;">Customer Name</label>
                    <input type="text" class="form-control" id="customer_name" name="customer_name" value="{{ customer_name|default:'' }}" placeholder="Enter customer name" required style="font-size: 0.85rem; padding: 5px 10px;">
                </div>

                <!-- Product Selection -->
                <select multiple class="form-control" name="product_ids" id="product_ids" style="font-size: 0.85rem; padding: 5px 10px;">
                    {% for product in products %}
                        <option value="{{ product.id }}" 
                            data-price="{{ product.selling_price }}" 
                            data-discounted-price="{{ product.discounted_price }}"   
                            data-discount="{{ product.discount }}" 
                            data-tax="{{ product.tax }}" 
                            data-stock="{{ product.quantity }}"
                            data-expiry="{{ product.expiry_date|date:'Y-m-d' }}"> <!-- Added Expiry Date -->
                            {{ product.name }} - GH₵{{ product.selling_price }}
                        </option>
                    {% empty %}
                        <option disabled>No products available for this store</option>
                    {% endfor %}
                </select>
                
                

                <!-- Quantity Input -->
                <div class="mb-2">
                    <label for="quantity" class="form-label" style="font-size: 0.85rem;">Quantity</label>
                    <input type="number" class="form-control" id="quantity" name="quantities" min="1" value="1" required style="font-size: 0.85rem; padding: 5px 10px;">
                </div>

                <!-- Add to Cart Button -->
                <button type="button" class="btn btn-secondary mb-2" onclick="addToCart()" style="font-size: 0.85rem; padding: 5px 10px;">Add to Cart</button>

                <!-- Hidden Input for Cart Data -->
                <input type="hidden" id="cart_data" name="cart_data">

                <!-- Hidden Inputs for Discount and Tax -->
                <input type="hidden" id="discount" name="discounts" value="0">
                <input type="hidden" id="tax" name="taxes" value="0">

                <!-- Payment Method -->
                <div class="mb-2">
                    <label for="payment_method" class="form-label" style="font-size: 0.85rem;">Payment Method</label>
                    <select class="form-control" id="payment_method" name="payment_method" style="font-size: 0.85rem; padding: 5px 10px;">
                        <option value="cash">Cash</option>
                        <option value="card">Card</option>
                        <option value="Mobile Money">Mobile Money</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                    </select>
                </div>

                <!-- Payment and Change Calculation -->
                <div class="mb-2">
                    <label for="amount_paid" class="form-label" style="font-size: 0.85rem;">Amount Paid</label>
                    <input type="number" class="form-control" id="amount_paid" name="amount_paid" style="font-size: 0.85rem; padding: 5px 10px;">
                </div>
                <div class="mb-2">
                    <button type="button" class="btn btn-success" onclick="calculateChange()" style="font-size: 0.85rem; padding: 5px 10px;">Calculate Change</button>
                    <div id="change" class="mt-1" style="font-size: 0.75rem;"></div>
                </div>
            </form>
        </div>

        <!-- Cart Table Section -->
        <div class="col-md-8" style="font-size: 0.9rem;">
            <div class="cart-section">
                <h4 class="mb-3" style="font-size: 1.2rem;">Cart</h4>
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Selling Price (GH₵0)</th>
                            <th>Subtotal (GH₵)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="cart-body">
                        <!-- Cart Items Will Be Dynamically Added Here -->
                    </tbody>
                </table>

                <!-- Total and Checkout Section -->
                <div class="mt-4">
                    <h5>Total: <span id="total-amount">GH₵0.00</span></h5>
                    <button class="btn btn-primary" id="generate_invoice_btn" onclick="checkout()">Generate Invoice</button>
                    <button type="button" id="resetCartButton" class="btn btn-danger">Reset Cart</button>
                </div>
            </div>
        </div>
    </div>
</div>



            


                        <!-- Edit Quantity Modal -->
            <div class="modal fade" id="editQuantityModal" tabindex="-1" aria-labelledby="editQuantityModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editQuantityModalLabel">Edit Quantity</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <label for="newQuantity">Enter new quantity:</label>
                            <input type="number" class="form-control" id="newQuantity" min="1">
                            <div id="error-message" class="text-danger mt-2" style="display: none;">Invalid quantity entered. Please enter a valid number greater than 0.</div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="saveQuantityButton">Save</button>
                        </div>
                    </div>
                </div>
            </div>

                        <!-- Delete Item Confirmation Modal -->
            <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Delete</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            Are you sure you want to remove this item from the cart?
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-danger" id="confirmDeleteButton">Delete</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Reset Cart Modal -->
<div class="modal fade" id="resetCartModal" tabindex="-1" aria-labelledby="resetCartModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resetCartModalLabel">Reset Cart</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="resetCartMessage">Are you sure you want to reset the cart?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmResetButton" class="btn btn-danger">Yes, Reset Cart</button>
            </div>
        </div>
    </div>
</div>



<!-- Generate Invoice Modal -->
<div class="modal fade" id="invoiceConfirmModal" tabindex="-1" aria-labelledby="invoiceConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="invoiceConfirmModalLabel">Generate Invoice</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to generate the invoice for the current cart?</p>
            </div>
            <div class="modal-footer">
                <!-- Cancel button to dismiss the modal -->
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <!-- Confirm button to generate the invoice -->
                <button type="button" id="confirmInvoiceBtn" class="btn btn-primary">Yes, Generate Invoice</button>
            </div>
        </div>
    </div>
</div>


<!-- Empty Cart Modal -->
<div class="modal fade" id="emptyCartModal" tabindex="-1" role="dialog" aria-labelledby="emptyCartModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="emptyCartModalLabel">Your Cart is Empty</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Please add items to your cart before proceeding with checkout.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelInvoiceBtn">Cancel</button>
            </div>
        </div>
    </div>
</div>



<!-- Modal for Low Stock Warning -->
<div class="modal fade" id="lowStockModal" tabindex="-1" aria-labelledby="lowStockModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="lowStockModalLabel">Low Stock Warning</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="lowStockMessage">
          <!-- Low stock message will be dynamically inserted here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  

  <!-- Expiry Warning Modal -->
<div class="modal fade" id="expiryModal" tabindex="-1" aria-labelledby="expiryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="expiryModalLabel">Product Expiry Alert</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="expiryMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

  
  <input type="hidden" id="invoice_id" value="{{ transaction_cart.id }}">


  <script>
    let cart = [];
const cartBody = document.getElementById('cart-body');
const totalAmount = document.getElementById('total-amount');
const changeDiv = document.getElementById('change');
const invoiceId = "{{ invoice_id }}"; // Dynamically passed from Django template

function addToCart() {
    const productSelect = document.getElementById('product_ids');
    const quantityInput = document.getElementById('quantity');

    const selectedProducts = Array.from(productSelect.selectedOptions);
    const quantity = parseInt(quantityInput.value) || 1;

    selectedProducts.forEach(option => {
        const productId = option.value;
        const productName = option.text.split(' - GH₵')[0];
        const sellingPrice = parseFloat(option.getAttribute('data-price')) || 0;
        const discountedPrice = parseFloat(option.getAttribute('data-discounted-price')) || sellingPrice;

        const discount = parseFloat(option.getAttribute('data-discount')) || 0;  // ✅ Capture discount
        const tax = parseFloat(option.getAttribute('data-tax')) || 0;            // ✅ Capture tax

        const existingItem = cart.find(item => item.id === productId);
        if (existingItem) {
            existingItem.quantity += quantity;
        } else {
            cart.push({
                id: productId,
                name: productName,
                price: discountedPrice,
                quantity: quantity,
                discount: discount,   // ✅ Store discount in cart data
                tax: tax              // ✅ Store tax in cart data
            });
        }

        // ✅ Update hidden inputs with the latest discount and tax
        document.getElementById('discount').value = discount;
        document.getElementById('tax').value = tax;
    });

    updateCart();
}


    function updateCart() {
        cartBody.innerHTML = '';
        let total = 0;

        cart.forEach((item, index) => {
            const subtotal = item.price * item.quantity;
            total += subtotal;

            const row = `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>GH₵${item.price.toFixed(2)}</td>  <!-- Corrected to GH₵ -->
                    <td>GH₵${subtotal.toFixed(2)}</td>  <!-- Corrected to GH₵ -->
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editQuantity(${index})">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="removeFromCart(${index})">Remove</button>
                    </td>
                </tr>
            `;
            cartBody.innerHTML += row;
        });

        totalAmount.textContent = `GH₵${total.toFixed(2)}`;  // Corrected to GH₵
        document.getElementById('cart_data').value = JSON.stringify(cart);
    }

    function removeFromCart(index) {
        // Open the modal and set up the delete action
        const deleteConfirmationModal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
        deleteConfirmationModal.show();

        // When the user confirms the deletion
        document.getElementById('confirmDeleteButton').onclick = function() {
            // Remove the item from the cart array
            cart.splice(index, 1);

            // Update the cart UI
            updateCart();

            // Close the modal
            deleteConfirmationModal.hide();
        }
    }

    function editQuantity(index) {
        // Open the modal and prefill the current quantity
        const currentQuantity = cart[index].quantity;
        document.getElementById('newQuantity').value = currentQuantity;
        
        // Show the modal
        const editQuantityModal = new bootstrap.Modal(document.getElementById('editQuantityModal'));
        editQuantityModal.show();

        // When the user clicks "Save", update the cart
        document.getElementById('saveQuantityButton').onclick = function() {
            const newQuantity = parseInt(document.getElementById('newQuantity').value);
            
            // Validate the input
            if (!isNaN(newQuantity) && newQuantity > 0) {
                // Update the quantity in the cart
                cart[index].quantity = newQuantity;
                updateCart(); // This function should update the cart UI
                editQuantityModal.hide(); // Close the modal
            } else {
                // Show error message if the input is invalid
                document.getElementById('error-message').style.display = 'block';
            }
        }
    }

    function calculateChange() {
        const finalTotal = parseFloat(totalAmount.textContent.replace('GH₵', ''));  // Corrected to GH₵
        const amountPaid = parseFloat(document.getElementById('amount_paid').value);
        const change = amountPaid - finalTotal;

        if (!isNaN(change)) {
            changeDiv.innerHTML = `Change: GH₵${change.toFixed(2)}`;  // Corrected to GH₵
        } else {
            changeDiv.innerHTML = 'Enter a valid amount paid.';
        }
    }

    function saveCartToBackend() {
        const cartData = {
            cart: cart, // Your cart array from JavaScript
            cart_id: "{{ request.session.cart_id|default:'' }}", // Use the session cart_id
            invoice_id: "{{ invoice_id|default:'' }}" // Optional: Pass an existing invoice ID
        };

        fetch('/billing/save-cart/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}' // Include CSRF token for Django
            },
            body: JSON.stringify(cartData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Cart saved successfully!');
                console.log('Response:', data);
            } else {
                alert('Failed to save cart: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function setCartId(cartId) {
        // Send an AJAX request to Django to save cart_id in the session
        console.log('Attempting to save cart_id:', cartId);
        fetch("{% url 'billing:save_cart_id' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ cart_id: cartId })
        })
        .then(response => response.json())
        .then(data => {
            console.log("Cart ID saved:", data.cart_id);
        })
        .catch(error => {
            console.error("Error saving cart_id:", error);
        });
    }

    function generateInvoice() {
        saveCartToBackend();
        setTimeout(() => {
            window.location.href = '/billing/generate-invoice/'; // Adjust this as per your routing
        }, 1000);
    }

    document.addEventListener('DOMContentLoaded', function () {
        $('#confirmInvoiceBtn').on('click', function () {
            console.log('Generate Invoice button clicked'); // Log to confirm the button click is detected

            const customerName = document.getElementById('customer_name').value;
            const amountPaid = document.getElementById('amount_paid').value;
            const paymentMethod = document.getElementById('payment_method').value; // Capture the selected payment method

            const formData = new FormData();
            formData.append('payment_method', paymentMethod);
            formData.append('customer_name', customerName);
            formData.append('amount_paid', amountPaid);
            formData.append('cart_data', JSON.stringify(cart));

            fetch(`/billing/generate_invoice/${invoiceId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('Invoice generated', data); // Log the response to check if the invoice is generated
                if (data.invoice_id) {
                    window.location.href = `/billing/invoice_receipt/${data.invoice_id}/`;
                } else {
                    alert('Failed to generate invoice');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while generating the invoice');
            });

            $('#invoiceConfirmModal').modal('hide');
        });

        $('#cancelInvoiceBtn').on('click', function () {
            console.log('Cancel button clicked, closing the modal'); // Log to confirm cancel button click
            $('#emptyCartModal').modal('hide');
        });
    });

    function checkout() {
        console.log('Checkout function triggered');

        if (cart.length === 0) {
            console.log('Cart is empty, showing empty cart modal');
            $('#emptyCartModal').modal('show');
            return;
        }

        console.log('Cart is not empty, showing invoice confirmation modal');
        $('#invoiceConfirmModal').modal('show');
    }

    function getCSRFToken() {
        let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        return csrfToken;
    }

    document.addEventListener('DOMContentLoaded', function () {
        function generateCartId() {
            return Math.floor(1000000000 + Math.random() * 9000000000); // Random 10-digit number
        }

        function saveCartId(cartId) {
            fetch('/billing/save_cart_id/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                },
                body: JSON.stringify({ cart_id: cartId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Cart ID saved successfully:', cartId);
                } else {
                    console.error('Failed to save cart ID.');
                }
            })
            .catch(error => console.error('Error saving cart ID:', error));
        }

        let cartId = sessionStorage.getItem('cart_id');
        if (!cartId) {
            const newCartId = generateCartId();
            sessionStorage.setItem('cart_id', newCartId);
            saveCartId(newCartId);
        } else {
            console.log('Cart ID already exists:', cartId);
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });

    function clearCart() {
        sessionStorage.removeItem('cart_id');
        fetch('/billing/clear_cart/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('Cart cleared:', data.cart_id);
                sessionStorage.setItem('cart_id', data.cart_id);
            }
        })
        .catch(error => console.error('Error clearing cart:', error));
    }

    document.addEventListener("DOMContentLoaded", function() {
        const resetCartButton = document.getElementById('resetCartButton');
        const confirmResetButton = document.getElementById('confirmResetButton');
        const resetCartMessage = document.getElementById('resetCartMessage');
        const resetCartModal = new bootstrap.Modal(document.getElementById('resetCartModal'));

        const salesLink = document.getElementById('salesLink');
        const reprintBillLink = document.getElementById('reprintBillLink'); 


        resetCartButton.addEventListener('click', function() {
            console.log("Reset Cart Button clicked");
            if (cart.length === 0) {
                resetCartMessage.innerText = "The cart is already empty.";
                confirmResetButton.style.display = "none";
            } else {
                resetCartMessage.innerText = "Are you sure you want to reset the cart?";
                confirmResetButton.style.display = "inline-block";
            }

            resetCartModal.show();
        });

        confirmResetButton.addEventListener('click', function() {
            fetch("/billing/clear_cart/", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log("Cart cleared successfully.");
                    cart = [];
                    updateCart();
                    resetCartModal.hide();
                } else {
                    console.error("Failed to clear the cart.");
                }
            })
            .catch(error => console.error("Error:", error));
        });

        salesLink.addEventListener('click', function(event) {
            event.preventDefault();

            fetch("/billing/clear_cart/", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log("Cart cleared successfully.");
                    cart = [];
                    updateCart();
                    window.location.href = salesLink.href;
                } else {
                    console.error("Failed to clear the cart.");
                }
            })
            .catch(error => console.error("Error:", error));
        });
    });


</script>



<!--
Javascrip to display Warnng message for Low product
-->
<script>
    document.getElementById('product_ids').addEventListener('change', function(e) {
        for (let i = 0; i < e.target.selectedOptions.length; i++) {
            let selectedOption = e.target.selectedOptions[i];
            let stockLevel = selectedOption.getAttribute('data-stock');
            
            // Log stockLevel to check its value
            console.log("Stock quantity:", stockLevel);

            // Check if the stockLevel is a valid number
            stockLevel = parseInt(stockLevel);

            // If it's not a valid number, skip this option
            if (isNaN(stockLevel)) {
                console.log("Invalid stock quantity, skipping...");
                continue;
            }

            // Define low stock threshold (10 or fewer)
            var lowStockThreshold = 10;

            if (stockLevel <= lowStockThreshold) {
                // Display modal with the low stock warning
                let message = "Warning: The selected product '" + selectedOption.text + "' is running low on stock (Only " + stockLevel + " left).";
                document.getElementById('lowStockMessage').textContent = message;
                new bootstrap.Modal(document.getElementById('lowStockModal')).show();
            }
        }
    });

</script>

<script>

document.addEventListener("DOMContentLoaded", function () {
    document.getElementById('product_ids').addEventListener('change', function(e) {
        let today = new Date();
        today.setHours(0, 0, 0, 0); // Remove time for accurate date comparison
        
        for (let i = 0; i < e.target.selectedOptions.length; i++) {
            let selectedOption = e.target.selectedOptions[i];
            let expiryDateStr = selectedOption.getAttribute('data-expiry'); // Get expiry date
            
            console.log("Expiry date:", expiryDateStr); // Debugging log
            
            if (!expiryDateStr) {
                console.log("No expiry date found, skipping...");
                continue;
            }
            
            let expiryDate = new Date(expiryDateStr); // Convert string to Date
            let timeDiff = expiryDate.getTime() - today.getTime(); // Difference in milliseconds
            let daysUntilExpiry = timeDiff / (1000 * 60 * 60 * 24); // Convert to days

            let expiryThreshold = 30; // Notify if expiry is within 30 days

            if (daysUntilExpiry <= expiryThreshold) {  
                let message = `⚠️ Warning: The selected product '${selectedOption.text}' is expiring soon (Expiry Date: ${expiryDateStr}).`;

                if (daysUntilExpiry < 0) {
                    message = `❌ Alert: The selected product '${selectedOption.text}' has already expired (Expiry Date: ${expiryDateStr}).`;
                }

                document.getElementById('expiryMessage').textContent = message;
                
                let expiryModal = new bootstrap.Modal(document.getElementById('expiryModal'));
                expiryModal.show();
            }
        }
    });
});

</script>
<!--==================================================
Back button to clear cart
-->
<script>
window.addEventListener('pageshow', function(event) {
    if (event.persisted || (window.performance && window.performance.getEntriesByType("navigation")[0].type === "back_forward")) {
        // Clear the cart session when navigating back
        fetch("/billing/clear_cart/", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log("Cart cleared after back navigation.");
                cart = [];
                updateCart();
            } else {
                console.error("Failed to clear the cart after back navigation.");
            }
        })
        .catch(error => console.error("Error:", error));
    }
});


</script>



<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap JS (Make sure this is included before your custom JS) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>


<!-- other body content -->

<script src="{% static 'js/script.js' %}"></script>
</body>


</body>




{% endblock %}
