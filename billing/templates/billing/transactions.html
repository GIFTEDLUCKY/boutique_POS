{% extends 'base.html' %}

{% load static %}

{% block content %}

{% if messages %}
    <div class="alert-container">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endif %}

<div class="container mx-auto my-4">
    <!-- Filter form: Responsive layout -->
    <!-- Filter/Search form -->
<form id="filterForm" method="GET" action="{% url 'billing:all_transactions' %}">
    <div class="d-flex flex-column flex-md-row flex-wrap gap-2 align-items-md-center mb-3">

        <!-- Start Date -->
        <div class="d-flex flex-column">
            <label for="startDate" class="text-sm font-medium mb-1">Start Date:</label>
            <input type="date" id="startDate" name="start_date"
            value="{{ request.GET.start_date }}"
            class="form-control border border-gray-300 rounded-lg p-2 w-100" />
        </div>

        <!-- End Date -->
        <div class="d-flex flex-column">
            <label for="endDate" class="text-sm font-medium mb-1">End Date:</label>
            <input type="date" id="endDate" name="end_date"
            value="{{ request.GET.end_date }}"
            class="form-control border border-gray-300 rounded-lg p-2 w-100" />
        </div>

        <!-- Filter Field -->
        <div class="d-flex flex-column" style="min-width: 200px;">
            <label for="filter_field" class="text-sm font-medium mb-1">Filter By:</label>
            <select id="filter_field" name="filter_field"
                class="form-select border border-gray-300 rounded-lg p-2"
                style="min-width: 200px;">
                <option value="product" {% if request.GET.filter_field == "product" %}selected{% endif %}>Product</option>
                <option value="store_name" {% if request.GET.filter_field == "store_name" %}selected{% endif %}>Store</option>
            </select>
        </div>

        <!-- Filter Value -->
        <div class="d-flex flex-column">
            <label for="filter_value" class="text-sm font-medium mb-1">Value:</label>
            <input type="text" id="filter_value" name="filter_value"
            value="{{ request.GET.filter_value }}"
            class="form-control border border-gray-300 rounded-lg p-2 w-100"
            placeholder="Enter value here" />
        </div>

        <!-- Search Button -->
        <div class="d-flex align-items-end">
            <button type="submit" class="btn btn-success mt-md-4">Search</button>
        </div>
    </div>
</form>




    <!-- RESET and EXPORT below the search line -->
    <div class="d-flex gap-2 align-items-start">
        <button id="resetButton" data-url="{% url 'billing:all_transactions' %}" class="btn btn-secondary">
            Reset
        </button>

        <form id="exportForm" method="get" action="{% url 'billing:export_transactions_to_excel' %}">
            <input type="hidden" name="start_date" value="{{ request.GET.start_date }}">
            <input type="hidden" name="end_date" value="{{ request.GET.end_date }}">
            <input type="hidden" name="filter_field" value="{{ request.GET.filter_field }}">
            <input type="hidden" name="filter_value" value="{{ request.GET.filter_value }}">
            <button type="submit" class="btn btn-primary" style="background: #055757; color: #ffffff;">
                Export to Excel
            </button>
        </form>
    </div>
</div>


<div class="flex gap-4 mb-6">
  <div style="display: flex; justify-content: flex-end; padding: 10px;">
    <h1 id="total_sales">
      Total Sales: {{ total_sales|floatformat:2 }}
    </h1>
    <h1 id="total_quantity" style="margin-left: 20px;">
      Total Quantity: {{ total_quantity|default:0 }}

    </h1>
  </div>
    <h2>Transaction Invoice Details</h2>
</div>

<div id="transactionTableContainer" class="overflow-x-auto">
    <table id="transactionTable" class="table-auto w-full border-collapse border border-gray-300" style="font-size: 13px;">
        <thead>
            <tr class="bg-gray-200 text-left">
                <th class="border px-4 py-2">Product</th>
                <th class="border px-4 py-2">Store</th>
                <th class="border px-4 py-2">Quantity</th>
                <th class="border px-4 py-2">Price</th>
                <th class="border px-4 py-2">Discount</th>
                <th class="border px-4 py-2">Tax</th>
                <th class="border px-4 py-2">Subtotal</th>
                <th class="border px-4 py-2">Adjusted Final Price</th>
                <th class="border px-4 py-2">Date</th>
            </tr>
        </thead>
        <tbody id="transactionTableBody">
            {% for transaction in transactions %}
            <tr class="even:bg-gray-100">
                <td class="border px-4 py-2">{{ transaction.product.name }}</td>
                <td class="border px-4 py-2">{{ transaction.store.name }}</td>
                <td class="border px-4 py-2">{{ transaction.quantity }}</td>
                <td class="border px-4 py-2">{{ transaction.price }}</td>
                <td class="border px-4 py-2">{{ transaction.product.discount }}</td>
                <td class="border px-4 py-2">{{ transaction.product.product_tax }}</td>
                <td class="border px-4 py-2">{{ transaction.subtotal }}</td>
                <td class="border px-4 py-2">{{ transaction.adjusted_final_price }}</td>
                <td class="border px-4 py-2">{{ transaction.created_at|date:"d-m-Y" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="d-flex justify-content-center align-items-center mt-3">
    {% with request.GET.urlencode as query_params %}
    {% if transactions.has_previous %}
        <a href="?page=1&{{ query_params|cut:'page=' }}" class="btn btn-sm btn-outline-primary mx-1">First</a>
        <a href="?page={{ transactions.previous_page_number }}&{{ query_params|cut:'page=' }}" class="btn btn-sm btn-outline-primary mx-1">Previous</a>
    {% endif %}

    <span class="px-3 py-1 border rounded bg-light fw-bold">
        Page {{ transactions.number }} of {{ transactions.paginator.num_pages }}
    </span>

    {% if transactions.has_next %}
        <a href="?page={{ transactions.next_page_number }}&{{ query_params|cut:'page=' }}" class="btn btn-sm btn-outline-primary mx-1">Next</a>
        <a href="?page={{ transactions.paginator.num_pages }}&{{ query_params|cut:'page=' }}" class="btn btn-sm btn-outline-primary mx-1">Last</a>
    {% endif %}
    {% endwith %}

</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'js/script.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>


{% endblock %}
