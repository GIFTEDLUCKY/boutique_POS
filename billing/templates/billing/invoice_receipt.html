{% extends 'base.html' %}

{% load static %}

{% block title %}Invoice Receipt{% endblock %}


{% block content %}


<!DOCTYPE html>
<html>
<head>
    <title>Invoice Receipt</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .invoice-container {
            width: 72mm; /* instead of 80mm */
            margin: 0 auto;
            padding: 5px; /* smaller padding so content fits inside printable area */
            border: 0.2px solid black; /* avoid printed border expanding the width */
            font-size: 12px;
        }

        h2, h3, hr {
            font-size: 13px;
            text-align: center;
            margin: 1px 0;
        }

        p {
            margin: 2px 0; /* was 5px 0 */
            font-size: 11px; /* slightly smaller */
            line-height: 1.2; /* tighter line height */
        }


        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            border: 0.2px solid black;
            line-height: 1;
        }

        table, th, td {
            
            font-size: 10px;
            text-align: left;
            border: 0.3px solid black;
            text-align: center;
            padding: 2px; 
        }

        th, td {
            padding: 5px;
        }

        .total {
            font-weight: bold;
            font-size: 10px;
        }

        body, table, p, td, th, h2, h3 {
            color: #000;              /* pure black */
            font-weight: 500;         /* bolden all text */
            -webkit-print-color-adjust: exact; /* prevents Chrome from lightening colors */
            print-color-adjust: exact;
        }

        @media print {
            body {
                margin: 0;
                padding: 0;
            }

            .invoice-container {
                margin: 0 auto;
                width: 72mm; /* Ensure correct width for receipt roll paper */
                page-break-after: auto; /* Ensures receipt prints as one page */
            }

            .btn-secondary, #print-button, #cancel-button {
                display: none; /* Hide buttons on print */
            }

            .navbar {
                display: none !important;
            }

	#license-notice {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
    }
        }
    </style>
</head>
<body>
    <div class="invoice-container">

        <div style="text-align: center;">
            <img src="{% static 'images/logo.png' %}" alt="Store Logo" style="max-width: 60px; max-height: 60px;">

        </div>
        
        <h2>Classic M Collection </h2>
<br>
        <h3>Invoice Details</h3>
        <hr>

        <p><strong>Invoice No.:</strong> {{ customer_invoice.invoice_number }} &nbsp; &nbsp;&nbsp;&nbsp;
        <strong>Cashier:</strong> {{ user.username }}</p>


        <p><strong>Location:</strong> {{ store_info.store_name }}</p>
        <p><strong>Customer:</strong> {{ customer_invoice.customer_name }}</p>
        <p><strong>Paid via:</strong> {{ payment_method_display }} &nbsp;&nbsp;&nbsp;
            <strong>Date:</strong> {{ customer_invoice.created_at|date:"d-m-Y H:i" }}</p>

        <table>
            <thead>
                <tr>
                    <th>S/No</th>
                    <th>Product</th>
                    <th>Qty</th>
                    <th>Price</th>
                    <th>Sub</th>
                </tr>
            </thead>
            <tbody>
                {% for item in cart_items %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ item.product.name }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>{{ item.price|floatformat:2 }}</td>
                    <td>{{ item.subtotal|floatformat:2 }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5">No items found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <hr>

        <table>
            <tr class="total">
                <td><strong>Total:</strong></td>
                <td>₵ {{ total|floatformat:2 }}</td>
            </tr>
            <tr>
                <td><strong>Amount Paid:</strong></td>
                <td>₵ {{ amount_paid|floatformat:2 }}</td>
            </tr>
            
            <tr>
                <td><strong>Change/Balance:</strong></td>
                <td>
                    {% if amount_paid == 0 or amount_paid is None %}
                        ₵ 0.00
                    {% elif change < 0 %}
                        Balance: ₵ {{ change|floatformat:2 }}
                    {% else %}
                        Change: ₵ {{ change|floatformat:2 }}
                    {% endif %}
                </td>
            </tr>

        </table>

        <p>Thank you for your patronage!</p>
        <p>Store Address: {{ store_info.location }}</p>
        <p>Contact: {{ store_info.manager_name }} &nbsp;&nbsp; {{ store_info.manager_contact }}</p>

        <div style="text-align: center;">
            {% if qr_code_base64 %}
                <img src="data:image/png;base64,{{ qr_code_base64 }}" alt="QR Code"
                    style="border: 0.5px solid black; width: 100px; height: 100px;">
            {% else %}
                <p>No QR Code available</p>
            {% endif %}
            <p><strong>Payment finalized for goods are non-refundable.</strong></p>
            <p>POS Designed by GLIMS Inventory: +233 50 375 1834</p>
        </div>

<!-- More transaction details here -->

        
        
    </div>

    <!-- Buttons -->
    <div class="invoice-footer mt-4 mb-4">
        <button id="print-button" class="btn btn-primary">Print Invoice</button>
        
        <button id="cancel-button" class="btn btn-danger">Cancel Invoice</button>

        {% if next_url %}
    <div class="text-center mt-4">
        <a href="{{ next_url }}" class="btn btn-secondary">Return to Invoice List</a>
    </div>
{% endif %}

    </div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const nextUrl = decodeURIComponent("{{ request.GET.next|urlencode }}");

    // Clear cart and redirect helper
    function clearCartAndRedirect(targetUrl) {
        fetch("{% url 'billing:clear_cart' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json",
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                window.location.href = targetUrl;
            } else {
                console.error("Failed to clear the cart.");
            }
        })
        .catch(error => console.error("Error:", error));
    }

    // Print button
    document.getElementById("print-button").addEventListener("click", function () {
        // 1️⃣ Open cash drawer via backend
        fetch("/billing/open_drawer/{{ customer_invoice.id }}/", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            }
        })
        .then(resp => resp.json())
        .then(data => {
            if (data.drawer_opened) {
                console.log("Cash drawer opened successfully!");
            } else {
                console.warn("Failed to open cash drawer.");
            }

            // 2️⃣ Trigger print
            window.print();

            // 3️⃣ Clear cart and redirect
            const redirectTarget = nextUrl ? nextUrl : "{% url 'billing:sales_view' %}";
            clearCartAndRedirect(redirectTarget);
        })
        .catch(err => {
            console.error("Drawer error:", err);
            // Print anyway
            window.print();
            const redirectTarget = nextUrl ? nextUrl : "{% url 'billing:sales_view' %}";
            clearCartAndRedirect(redirectTarget);
        });
    });

    // Cancel button
    document.getElementById("cancel-button").addEventListener("click", function () {
        const redirectTarget = nextUrl ? nextUrl : "{% url 'billing:sales_view' %}";
        clearCartAndRedirect(redirectTarget);
    });

    // Optional: handle back button
    function handleBackButton() {
        const redirectTarget = nextUrl ? nextUrl : "{% url 'billing:sales_view' %}";
        clearCartAndRedirect(redirectTarget);
    }

    window.addEventListener('popstate', handleBackButton);
    window.history.pushState(null, "", window.location.href);
});
</script>


          
</body>
</html>
{% endblock %}
